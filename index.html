<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction Master Class</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <style>
        :root {
            /* Palette */
            --c-green: #4CAF50;
            --c-green-light: #e8f5e9;
            --c-blue: #2196F3;
            --c-blue-light: #e3f2fd;
            --c-gold: #FFC107; 
            --c-gold-light: #fff8e1;
            --c-red: #ef5350; 
            
            --bg-body: #f0f4f8;
            --bg-card: #ffffff;
            --text-main: #37474f;
            --text-muted: #78909c;
            --border: #cfd8dc;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 60px;
        }

        /* --- HEADER --- */
        .header {
            width: 100%;
            background: white;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .header h1 {
            font-family: 'Fredoka', sans-serif;
            color: var(--text-main);
            letter-spacing: 0.5px;
            font-size: 1.5rem;
        }

        /* --- NAVIGATION --- */
        .main-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #dfe6e9;
            padding: 6px;
            border-radius: 50px;
        }
        .nav-tab {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 10px 25px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.2s;
            font-weight: 600;
        }
        .nav-tab.active {
            background: white;
            color: var(--c-green);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .nav-tab:hover:not(.active) { color: var(--text-main); background: rgba(255,255,255,0.5); }

        /* --- SECTIONS --- */
        .tool-section {
            display: none;
            width: 100%;
            max-width: 900px;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.3s ease;
            padding: 0 15px;
        }
        .tool-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DASHBOARD & CONTROLS --- */
        .dashboard {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            border: 1px solid white;
        }

        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }

        /* Toggle Switch */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #eceff1;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            user-select: none;
        }
        .switch-label { font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); }
        .toggle-switch {
            position: relative; width: 44px; height: 24px;
            background: #b0bec5; border-radius: 20px; transition: 0.3s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .switch-container.active .toggle-switch { background: var(--c-gold); }
        .switch-container.active .toggle-switch::after { transform: translateX(20px); }
        .switch-container.active .switch-label { color: #3e2723; }

        /* --- INPUTS --- */
        .equation-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }
        .frac-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90px;
            position: relative;
            padding: 10px;
            border-radius: 12px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .frac-group.focus-green { background: var(--c-green-light); border-color: var(--c-green); }
        .frac-group.focus-blue { background: var(--c-blue-light); border-color: var(--c-blue); }

        .frac-input {
            width: 100%;
            font-family: 'Fredoka', sans-serif;
            font-size: 2.2rem;
            text-align: center;
            background: white;
            border: 2px solid #eceff1;
            color: var(--text-main);
            border-radius: 8px;
            padding: 5px 0;
            transition: all 0.2s;
        }
        .frac-input:focus { outline: none; border-color: var(--text-muted); }
        .frac-input:disabled { background: #f5f5f5; color: #b0bec5; cursor: not-allowed; }
        
        .input-green { color: var(--c-green); }
        .input-blue { color: var(--c-blue); }

        .frac-bar { width: 100%; height: 4px; background: var(--text-main); margin: 8px 0; border-radius: 2px; opacity: 0.8; }
        .operator { font-size: 3rem; color: var(--text-muted); font-family: 'Fredoka', sans-serif; margin: 0 10px; font-weight: 300; }

        /* Result Styles */
        .res-container { 
            min-width: 90px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
        }
        .res-text { 
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5rem; 
            font-weight: bold; 
            color: var(--text-main); 
            line-height: 1.1;
        }

        /* Simplified result */
        .simplified-badge {
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--c-gold);
            background: var(--c-gold-light);
            border: 1px solid var(--c-gold);
            border-radius: 20px;
            padding: 3px 12px;
            margin-top: 6px;
            display: none;
            white-space: nowrap;
        }

        /* Ghost Labels (LCD Hints) */
        .ghost-label {
            position: absolute; top: -35px;
            background: var(--c-gold); color: #3e2723;
            padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;
            opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .show-common .ghost-label { opacity: 1; transform: translateY(0); }

        /* --- BUTTONS --- */
        .btn {
            padding: 8px 20px; border-radius: 30px; font-family: 'Fredoka', sans-serif; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.2s; font-size: 0.95rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        .btn-outline { background: white; border: 2px solid var(--border); color: var(--text-muted); }
        .btn-green { background: var(--c-green); color: white; box-shadow: 0 4px 10px rgba(76,175,80,0.3); }
        .btn-blue { background: var(--c-blue); color: white; box-shadow: 0 4px 10px rgba(33,150,243,0.3); }
        .btn-gold { background: var(--c-gold); color: #3e2723; box-shadow: 0 4px 10px rgba(255,193,7,0.4); }

        /* --- VISUALS --- */
        .vis-container { width: 100%; display: flex; flex-direction: column; gap: 20px; }
        .vis-card {
            background: var(--bg-card); border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid #eceff1;
        }
        .vis-label {
            font-family: 'Fredoka', sans-serif; text-transform: uppercase; letter-spacing: 1.5px;
            font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 20px;
        }

        /* SVG Styles */
        svg { overflow: visible; }
        .shape-stroke { stroke: var(--text-main); stroke-width: 2px; }
        .fill-empty { fill: white; }
        .fill-green { fill: var(--c-green); }
        .fill-blue { fill: var(--c-blue); }
        .sub-line { stroke: var(--c-gold); stroke-width: 2px; stroke-dasharray: 4 3; opacity: 0; transition: opacity 0.5s; }
        .show-common .sub-line { opacity: 1; }

        /* Number Line Specifics */
        .nl-text-small { font-family: 'Fredoka', sans-serif; font-size: 14px; fill: var(--text-muted); font-weight: 500; }
        .nl-text-large { font-family: 'Fredoka', sans-serif; font-size: 24px; font-weight: bold; fill: var(--text-main); }

        /* --- LCD CHART STYLES --- */
        .chart-container { overflow-x: auto; max-width: 100%; padding: 10px; }
        .mult-chart { border-collapse: separate; border-spacing: 3px; margin: 0 auto; }
        .mult-chart td, .mult-chart th {
            width: 42px; height: 42px; text-align: center;
            font-family: 'Fredoka', sans-serif; font-size: 14px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .col-header { background: #eceff1; color: var(--text-muted); font-weight: bold; }
        .col-header:hover { background: #cfd8dc; }
        .col-header.sel-green { background: var(--c-green); color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(76,175,80,0.3); }
        .col-header.sel-blue { background: var(--c-blue); color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(33,150,243,0.3); }
        
        .data-cell { background: white; color: var(--text-muted); border: 1px solid #f0f0f0; }
        .data-cell.hl-green { background: var(--c-green-light); color: var(--c-green); font-weight: bold; border-color: var(--c-green); }
        .data-cell.hl-blue { background: var(--c-blue-light); color: var(--c-blue); font-weight: bold; border-color: var(--c-blue); }
        .data-cell.lcd-match { 
            background: var(--c-gold); color: #3e2723; font-weight: 800;
            transform: scale(1.2); z-index: 10;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.6);
            border: 2px solid white;
        }
        
        .challenge-box {
            background: var(--c-gold-light); border: 2px solid var(--c-gold);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            width: 100%; max-width: 500px; text-align: center; display: none;
        }

        /* LCD Explainer */
        .explainer {
            max-width: 600px; width: 100%; margin-top: 20px;
            border-radius: 12px; background: white; border: 1px solid var(--border); overflow: hidden;
        }
        .explainer-toggle {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 18px; cursor: pointer;
            font-family: 'Fredoka', sans-serif; font-weight: 600;
            background: #f9f9f9; color: var(--text-muted);
        }
        .explainer-content { padding: 15px; border-top: 1px solid var(--border); font-size: 0.95rem; line-height: 1.6; }
        .step-num { 
            display: inline-block; background: var(--c-gold); color: #3e2723; 
            width: 20px; height: 20px; border-radius: 50%; 
            text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; margin-right: 5px; 
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>Fraction Master Class</h1>
    </div>

    <div class="main-nav">
        <button class="nav-tab active" onclick="switchTab('tab-fractions')">Fraction Lab</button>
        <button class="nav-tab" onclick="switchTab('tab-lcd')">LCD Finder</button>
    </div>

    <div id="tab-fractions" class="tool-section active">
        
        <div class="dashboard">
            
            <div class="controls-row">
                <div style="display:flex; gap:10px;">
                    <button id="btn-paint-a" class="btn btn-green" onclick="setPaintMode('a')">Paint Green</button>
                    <button id="btn-paint-b" class="btn btn-outline" onclick="setPaintMode('b')">Paint Blue</button>
                </div>

                <div class="switch-container" id="mode-toggle" onclick="toggleUnlikeMode()">
                    <span class="switch-label">Different Denominators</span>
                    <div class="toggle-switch"></div>
                </div>
            </div>

            <div class="equation-wrapper">
                <div class="frac-group focus-green" id="grp-1">
                    <div class="ghost-label" id="ghost-1"></div>
                    <input type="number" id="n1" class="frac-input input-green" value="1" min="0" oninput="updateLab()">
                    <div class="frac-bar"></div>
                    <input type="number" id="d1" class="frac-input" value="4" min="1" max="12" oninput="handleDenomChange(1, this.value)">
                </div>

                <div class="operator">+</div>

                <div class="frac-group" id="grp-2">
                    <div class="ghost-label" id="ghost-2"></div>
                    <input type="number" id="n2" class="frac-input input-blue" value="1" min="0" oninput="updateLab()">
                    <div class="frac-bar"></div>
                    <input type="number" id="d2" class="frac-input" value="4" min="1" max="12" oninput="handleDenomChange(2, this.value)" disabled>
                </div>

                <div class="operator">=</div>

                <div class="res-container">
                    <div id="res-final" style="display:flex; flex-direction:column; align-items:center;">
                        <span id="rn" class="res-text">2</span>
                        <div class="frac-bar" style="width:100%;"></div>
                        <span id="rd" class="res-text">4</span>
                    </div>
                    <div id="res-unknown" class="res-text" style="display:none; color:#ccc;">?</div>
                    <div id="simplified-badge" class="simplified-badge"></div>
                </div>
            </div>

            <button class="btn btn-gold" id="btn-common" onclick="toggleCommonGrid()" style="display:none; margin-top:10px;">
                Show Common Grid
            </button>
        </div>

        <div class="vis-container" id="vis-root">
            <div class="vis-card">
                <div class="vis-label">Bar Model (Click to Paint)</div>
                <div id="vis-bars" style="width:100%; display:flex; flex-direction:column; align-items:center; gap:15px;"></div>
            </div>
            
            <div class="vis-card">
                <div class="vis-label">Circle Model (Click to Paint)</div>
                <div id="vis-pies" style="display:flex; flex-wrap:wrap; gap:30px; justify-content:center;"></div>
            </div>

            <div class="vis-card">
                <div class="vis-label">Number Line</div>
                <div id="vis-line" style="width:100%; overflow-x:auto; padding-bottom:10px;"></div>
            </div>
        </div>
    </div>

    <div id="tab-lcd" class="tool-section">
        
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-gold" id="btn-lcd-explore" onclick="lcd_setMode('explore')">Explore</button>
            <button class="btn btn-outline" id="btn-lcd-challenge" onclick="lcd_setMode('challenge')">Challenge</button>
        </div>

        <div class="challenge-box" id="challengeBox">
            <p id="challengePrompt" style="font-size:1.2rem; margin-bottom:10px; font-family:'Fredoka',sans-serif;"></p>
            <input type="number" id="challengeInput" class="frac-input" style="width:100px; display:inline-block; font-size:1.5rem;" placeholder="?">
            <button class="btn btn-green" onclick="lcd_checkAnswer()">Check</button>
            <div id="challengeFeedback" style="margin-top:10px; font-weight:bold; min-height:24px;"></div>
        </div>

        <div class="dashboard" id="lcd-dashboard">
            <div id="narration" style="font-family:'Fredoka',sans-serif; font-size:1.1rem; color:var(--text-main); min-height:30px;">
                Pick two denominators in the top row to start.
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" onclick="lcd_reset()">Reset</button>
                <button class="btn btn-gold" id="lcd-btn-anim" onclick="lcd_animate()" disabled>Show Multiples</button>
            </div>
        </div>

        <div class="chart-container">
            <table class="mult-chart" id="lcd-table"></table>
        </div>

        <div class="explainer">
            <div class="explainer-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                <span>How to Find the LCD</span> <span>▼</span>
            </div>
            <div class="explainer-content" style="display:none">
                <p><span class="step-num">1</span> <strong>Check:</strong> Does the smaller number divide into the bigger one? If yes, the bigger number is the LCD! (e.g. 2 and 6 → LCD is 6).</p>
                <p style="margin-top:8px;"><span class="step-num">2</span> <strong>If not:</strong> List the multiples of each until you find a match. (e.g. 4 and 6 → 4, 8, 12... vs 6, 12... Match at 12).</p>
                <p style="margin-top:8px;"><span class="step-num">3</span> <strong>Shortcut:</strong> If they share no factors, just multiply them. (e.g. 3 and 5 → 15).</p>
            </div>
        </div>
    </div>

<script>
    // --- GLOBAL NAV ---
    function switchTab(tabId) {
        document.querySelectorAll('.tool-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        const idx = tabId === 'tab-fractions' ? 0 : 1;
        document.querySelectorAll('.nav-tab')[idx].classList.add('active');
    }

    // =====================================================
    // LOGIC: FRACTION LAB (Unified)
    // =====================================================
    let state = {
        n1: 1, d1: 4,
        n2: 1, d2: 4,
        paintMode: 'a', // 'a' (green) or 'b' (blue)
        unlikeMode: false,
        showCommon: false
    };

    // --- Interaction Handlers ---

    function setPaintMode(mode) {
        state.paintMode = mode;
        const btnA = document.getElementById('btn-paint-a');
        const btnB = document.getElementById('btn-paint-b');
        const grp1 = document.getElementById('grp-1');
        const grp2 = document.getElementById('grp-2');

        if(mode === 'a') {
            btnA.className = 'btn btn-green'; btnB.className = 'btn btn-outline';
            grp1.classList.add('focus-green'); grp2.classList.remove('focus-blue');
        } else {
            btnA.className = 'btn btn-outline'; btnB.className = 'btn btn-blue';
            grp1.classList.remove('focus-green'); grp2.classList.add('focus-blue');
        }
    }

    function toggleUnlikeMode() {
        state.unlikeMode = !state.unlikeMode;
        state.showCommon = false;
        
        const toggleEl = document.getElementById('mode-toggle');
        const d2Input = document.getElementById('d2');
        const commonBtn = document.getElementById('btn-common');

        if(state.unlikeMode) {
            toggleEl.classList.add('active');
            d2Input.disabled = false;
            commonBtn.style.display = 'inline-block';
            commonBtn.innerText = "Show Common Grid";
            commonBtn.classList.remove('active');
        } else {
            toggleEl.classList.remove('active');
            d2Input.disabled = true;
            state.d2 = state.d1;
            d2Input.value = state.d1;
            commonBtn.style.display = 'none';
        }
        document.getElementById('tab-fractions').classList.remove('show-common');
        updateLab();
    }

    function toggleCommonGrid() {
        state.showCommon = !state.showCommon;
        const btn = document.getElementById('btn-common');
        const root = document.getElementById('tab-fractions');
        
        if(state.showCommon) {
            btn.classList.add('active');
            btn.innerText = "Hide Common Grid";
            root.classList.add('show-common');
        } else {
            btn.classList.remove('active');
            btn.innerText = "Show Common Grid";
            root.classList.remove('show-common');
        }
        updateLab();
    }

    function handleDenomChange(which, val) {
        let v = parseInt(val) || 1;
        if(v > 12) v = 12; if(v < 1) v = 1;

        if(which === 1) {
            state.d1 = v;
            if(!state.unlikeMode) {
                state.d2 = v;
                document.getElementById('d2').value = v;
            }
        } else {
            state.d2 = v;
        }
        updateLab();
    }

    // --- Main Update ---

    const gcd = (a, b) => b == 0 ? a : gcd(b, a % b);
    const lcm = (a, b) => (a * b) / gcd(a, b);

    function updateLab() {
        // Read numerators
        state.n1 = parseInt(document.getElementById('n1').value) || 0;
        state.n2 = parseInt(document.getElementById('n2').value) || 0;
        
        const cd = lcm(state.d1, state.d2);

        // Update Ghost Labels
        const n1_conv = state.n1 * (cd/state.d1);
        const n2_conv = state.n2 * (cd/state.d2);
        document.getElementById('ghost-1').innerText = `${n1_conv}/${cd}`;
        document.getElementById('ghost-2').innerText = `${n2_conv}/${cd}`;

        // Result Logic
        const resFinal = document.getElementById('res-final');
        const resUnk = document.getElementById('res-unknown');
        const simplBadge = document.getElementById('simplified-badge');
        
        if(state.d1 === state.d2 || state.showCommon) {
            resFinal.style.display = 'flex';
            resUnk.style.display = 'none';
            
            const sumNum = n1_conv + n2_conv;
            document.getElementById('rn').innerText = sumNum;
            document.getElementById('rd').innerText = cd;

            // FIX 5: Show simplified form
            const g = gcd(Math.abs(sumNum), cd);
            const simpNum = sumNum / g;
            const simpDen = cd / g;
            
            if(g > 1 && sumNum > 0) {
                if(simpDen === 1) {
                    simplBadge.innerText = `= ${simpNum}`;
                } else {
                    const wholepart = Math.floor(simpNum / simpDen);
                    const remainder = simpNum % simpDen;
                    if(wholepart >= 1 && remainder > 0) {
                        simplBadge.innerText = `= ${wholepart} ${remainder}/${simpDen}`;
                    } else {
                        simplBadge.innerText = `= ${simpNum}/${simpDen}`;
                    }
                }
                simplBadge.style.display = 'inline-block';
            } else if(sumNum > 0 && sumNum > cd) {
                // Not reducible but improper — show mixed number
                const wholepart = Math.floor(sumNum / cd);
                const remainder = sumNum % cd;
                if(wholepart >= 1 && remainder > 0) {
                    simplBadge.innerText = `= ${wholepart} ${remainder}/${cd}`;
                    simplBadge.style.display = 'inline-block';
                } else if(remainder === 0) {
                    simplBadge.innerText = `= ${wholepart}`;
                    simplBadge.style.display = 'inline-block';
                } else {
                    simplBadge.style.display = 'none';
                }
            } else {
                simplBadge.style.display = 'none';
            }
        } else {
            resFinal.style.display = 'none';
            resUnk.style.display = 'block';
            simplBadge.style.display = 'none';
        }

        renderBars(cd);
        renderPies(cd);
        renderLine(cd);
    }

    // FIX 1: Reworked click logic — clicking directly adds/removes from the correct fraction
    function clickPiece(fracId, operation) {
        if(fracId === 1) {
            if(operation === 'add') state.n1++;
            else state.n1 = Math.max(0, state.n1 - 1);
        } else {
            if(operation === 'add') state.n2++;
            else state.n2 = Math.max(0, state.n2 - 1);
        }
        document.getElementById('n1').value = state.n1;
        document.getElementById('n2').value = state.n2;
        updateLab();
    }

    // --- Renderers ---

    function renderBars(cd) {
        const container = document.getElementById('vis-bars');
        container.innerHTML = '';

        const drawBar = (n, d, colorCls, fracId) => {
            const w = 600; const h = 50;
            const svgNS = "http://www.w3.org/2000/svg";
            const wholes = Math.ceil(Math.max(1, n/d));
            const totalW = Math.max(w, w*(n/d)) + 10;
            
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%"); svg.setAttribute("viewBox", `0 0 ${totalW} ${h+20}`);
            
            for(let i=0; i<wholes*d; i++) {
                const segW = w/d;
                const x = i * segW;
                
                const rect = document.createElementNS(svgNS, "rect");
                rect.setAttribute("x", x); rect.setAttribute("y", 10);
                rect.setAttribute("width", segW); rect.setAttribute("height", h);
                rect.setAttribute("stroke", "#37474f"); rect.setAttribute("stroke-width", 2);
                
                if(i < n) rect.setAttribute("class", colorCls);
                else rect.setAttribute("fill", "white");
                
                rect.style.cursor = "pointer";
                rect.onclick = () => {
                    if(i < n) clickPiece(fracId, 'sub');
                    else clickPiece(fracId, 'add');
                };
                
                svg.appendChild(rect);
            }

            // Common Grid Overlay
            if(state.showCommon && cd !== d) {
                for(let i=1; i<wholes*cd; i++) {
                    const x = i * (w/cd);
                    if((i*d)%cd !== 0) {
                        const l = document.createElementNS(svgNS, "line");
                        l.setAttribute("x1", x); l.setAttribute("x2", x);
                        l.setAttribute("y1", 10); l.setAttribute("y2", 10+h);
                        l.setAttribute("class", "sub-line");
                        l.style.pointerEvents = "none"; 
                        svg.appendChild(l);
                    }
                }
            }
            container.appendChild(svg);
        };

        drawBar(state.n1, state.d1, 'fill-green', 1);
        drawBar(state.n2, state.d2, 'fill-blue', 2);
        
        // Result Bar
        const drawResult = () => {
             const w = 600; const h = 50; const gap = 15;
             const val1 = state.n1/state.d1; 
             const val2 = state.n2/state.d2;
             const total = val1 + val2;
             const wholes = Math.ceil(Math.max(1, total));
             const svgNS = "http://www.w3.org/2000/svg";
             
             const totalH = (h * wholes) + (gap * (wholes-1)) + 20;
             const svg = document.createElementNS(svgNS, "svg");
             svg.setAttribute("width", "100%"); svg.setAttribute("viewBox", `0 0 ${w+4} ${totalH}`);

             let remG = val1;
             let remB = val2;

             for(let r=0; r<wholes; r++){
                 const y = 10 + r*(h+gap);
                 const frame = document.createElementNS(svgNS, "rect");
                 frame.setAttribute("x", 0); frame.setAttribute("y", y);
                 frame.setAttribute("width", w); frame.setAttribute("height", h);
                 frame.setAttribute("stroke", "#37474f"); frame.setAttribute("stroke-width", 2);
                 frame.setAttribute("fill", "white");
                 svg.appendChild(frame);

                 let gInRow = Math.min(remG, 1.0);
                 if(gInRow > 0) {
                     const rG = document.createElementNS(svgNS, "rect");
                     rG.setAttribute("x", 0); rG.setAttribute("y", y);
                     rG.setAttribute("width", gInRow*w); rG.setAttribute("height", h);
                     rG.setAttribute("class", "fill-green");
                     svg.appendChild(rG);
                     remG -= gInRow; if(remG < 0.001) remG = 0;
                 }

                 if(remB > 0 && gInRow < 1.0) {
                     let spaceLeft = 1.0 - gInRow;
                     let bInRow = Math.min(remB, spaceLeft);
                     
                     const rB = document.createElementNS(svgNS, "rect");
                     rB.setAttribute("x", gInRow*w); rB.setAttribute("y", y);
                     rB.setAttribute("width", bInRow*w); rB.setAttribute("height", h);
                     rB.setAttribute("class", "fill-blue");
                     svg.appendChild(rB);
                     
                     remB -= bInRow; if(remB < 0.001) remB = 0;
                 }

                 if(state.showCommon) {
                     for(let i=1; i<cd; i++) {
                         const x = i * (w/cd);
                         const l = document.createElementNS(svgNS, "line");
                         l.setAttribute("x1", x); l.setAttribute("x2", x);
                         l.setAttribute("y1", y); l.setAttribute("y2", y+h);
                         l.setAttribute("class", "sub-line");
                         l.style.opacity = 0.8;
                         svg.appendChild(l);
                     }
                 } else {
                     if(gInRow > 0.001 && gInRow < 0.999) {
                         const x = gInRow*w;
                         const l = document.createElementNS(svgNS, "line");
                         l.setAttribute("x1", x); l.setAttribute("x2", x);
                         l.setAttribute("y1", y); l.setAttribute("y2", y+h);
                         l.setAttribute("stroke", "white"); l.setAttribute("stroke-width", 2);
                         svg.appendChild(l);
                     }
                 }
             }
             container.appendChild(svg);
        };
        drawResult();
    }

    // FIX 2: Circle model now includes common grid overlay lines
    function renderPies(cd) {
        const container = document.getElementById('vis-pies');
        container.innerHTML = '';
        
        const svgNS = "http://www.w3.org/2000/svg";

        const drawPie = (n, d, colorCls, fracId) => {
            const wholes = Math.ceil(Math.max(1, n/d));
            
            for(let w=0; w<wholes; w++) {
                const svg = document.createElementNS(svgNS, "svg");
                svg.setAttribute("width", "120"); svg.setAttribute("height", "120");
                svg.setAttribute("viewBox", "-5 -5 110 110");
                const cx=50, cy=50, r=50;

                // Draw the main slices
                for(let i=0; i<d; i++) {
                    const absIdx = (w*d) + i;
                    const startA = (i*360/d) - 90;
                    const endA = ((i+1)*360/d) - 90;
                    const x1 = cx + r * Math.cos(startA*Math.PI/180);
                    const y1 = cy + r * Math.sin(startA*Math.PI/180);
                    const x2 = cx + r * Math.cos(endA*Math.PI/180);
                    const y2 = cy + r * Math.sin(endA*Math.PI/180);
                    const large = (endA - startA) > 180 ? 1 : 0;
                    
                    const path = document.createElementNS(svgNS, "path");
                    path.setAttribute("d", `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`);
                    
                    if(absIdx < n) path.setAttribute("class", `shape-stroke ${colorCls}`);
                    else path.setAttribute("class", "shape-stroke fill-empty");
                    
                    path.style.cursor = "pointer";
                    path.onclick = () => {
                         if(absIdx < n) clickPiece(fracId, 'sub');
                         else clickPiece(fracId, 'add');
                    };
                    svg.appendChild(path);
                }

                // FIX 2: Common grid overlay — draw subdivision lines for the LCD
                if(state.showCommon && cd !== d) {
                    for(let i=0; i<cd; i++) {
                        // Only draw lines that don't already exist from the main slices
                        if((i * d) % cd !== 0) {
                            const angle = (i * 360 / cd) - 90;
                            const lx = cx + r * Math.cos(angle * Math.PI / 180);
                            const ly = cy + r * Math.sin(angle * Math.PI / 180);
                            
                            const line = document.createElementNS(svgNS, "line");
                            line.setAttribute("x1", cx);
                            line.setAttribute("y1", cy);
                            line.setAttribute("x2", lx);
                            line.setAttribute("y2", ly);
                            line.setAttribute("class", "sub-line");
                            line.style.pointerEvents = "none";
                            svg.appendChild(line);
                        }
                    }
                }

                container.appendChild(svg);
            }
        };

        drawPie(state.n1, state.d1, 'fill-green', 1);
        drawPie(state.n2, state.d2, 'fill-blue', 2);
    }

    // FIX 3: Number line with smart label filtering for large LCDs
    function renderLine(cd) {
        const container = document.getElementById('vis-line');
        container.innerHTML = '';
        
        const tickD = cd;
        
        const val1 = state.n1/state.d1; 
        const val2 = state.n2/state.d2;
        const total = val1 + val2;
        const wholes = Math.ceil(Math.max(1, total));
        
        // Calculate smart label interval based on LCD size
        // If there are too many ticks, only label every Nth one
        const totalTicks = wholes * tickD;
        let labelInterval = 1;
        if(totalTicks > 40) labelInterval = 5;
        else if(totalTicks > 24) labelInterval = 3;
        else if(totalTicks > 16) labelInterval = 2;
        
        const minW = 800;
        const pixelsPerTick = Math.max(30, minW / totalTicks); // At least 30px per tick
        const w = Math.max(minW, totalTicks * pixelsPerTick + 80);
        
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", w); svg.setAttribute("height", "120");
        
        const margin = 40; const lineY = 60; const effW = w - 2*margin;
        const step = effW / totalTicks;

        // Main line
        const line = document.createElementNS(svgNS, "line");
        line.setAttribute("x1", margin); line.setAttribute("y1", lineY);
        line.setAttribute("x2", w-margin); line.setAttribute("y2", lineY);
        line.setAttribute("stroke", "#37474f"); line.setAttribute("stroke-width", 2);
        svg.appendChild(line);

        for(let i=0; i<=totalTicks; i++){
            const x = margin + i*step;
            const isWhole = i % tickD === 0;
            const tick = document.createElementNS(svgNS, "line");
            tick.setAttribute("x1", x); tick.setAttribute("x2", x);
            tick.setAttribute("y1", lineY); tick.setAttribute("y2", lineY + (isWhole ? 20:10));
            tick.setAttribute("stroke", "#37474f");
            svg.appendChild(tick);

            // Smart fraction label — only show at intervals or at key positions
            const showLabel = isWhole || (i % labelInterval === 0);
            if(showLabel) {
                const smTxt = document.createElementNS(svgNS, "text");
                smTxt.setAttribute("x", x); smTxt.setAttribute("y", lineY + 30);
                smTxt.setAttribute("text-anchor", "middle");
                smTxt.textContent = `${i}/${tickD}`;
                smTxt.setAttribute("class", "nl-text-small");
                svg.appendChild(smTxt);
            }

            // Large Integer Label at whole numbers
            if(isWhole) {
                const lgTxt = document.createElementNS(svgNS, "text");
                lgTxt.setAttribute("x", x); lgTxt.setAttribute("y", lineY + 60);
                lgTxt.setAttribute("text-anchor", "middle");
                lgTxt.textContent = i/tickD;
                lgTxt.setAttribute("class", "nl-text-large");
                svg.appendChild(lgTxt);
            }
        }
        
        // Jumps
        if(val1 > 0) {
            const width1 = val1 * effW / wholes;
            const x1 = margin; const x2 = margin + width1;
            svg.appendChild(createJump(svgNS, x1, x2, lineY, 'var(--c-green)'));
        }
        if(val2 > 0) {
            const width1 = val1 * effW / wholes;
            const width2 = val2 * effW / wholes;
            const start = margin + width1;
            const end = start + width2;
            svg.appendChild(createJump(svgNS, start, end, lineY, 'var(--c-blue)'));
        }
        
        container.appendChild(svg);
    }
    
    function createJump(ns, x1, x2, y, color) {
        const path = document.createElementNS(ns, "path");
        const mid = (x1+x2)/2; const h = Math.min(50, 25 + (x2-x1)/12);
        path.setAttribute("d", `M ${x1} ${y-10} Q ${mid} ${y-10-h} ${x2} ${y-10}`);
        path.setAttribute("fill", "none"); path.setAttribute("stroke", color); path.setAttribute("stroke-width", 4);
        return path;
    }

    // =====================================================
    // LOGIC: LCD FINDER
    // =====================================================
    const LCD_SIZE = 12;
    let lcd_selA = null;
    let lcd_selB = null;
    let lcd_mode = 'explore';
    let lcd_animating = false;
    let lcd_pair = null;

    function lcd_init() {
        const table = document.getElementById('lcd-table');
        table.innerHTML = '';
        
        const hRow = document.createElement('tr');
        hRow.innerHTML = '<th style="background:transparent; border:none;">×</th>';
        for(let c=1; c<=LCD_SIZE; c++){
            const th = document.createElement('th');
            th.className = 'col-header';
            th.textContent = c;
            th.dataset.num = c;
            th.onclick = () => lcd_select(c);
            hRow.appendChild(th);
        }
        table.appendChild(hRow);

        for(let r=1; r<=LCD_SIZE; r++){
            const row = document.createElement('tr');
            row.innerHTML = `<td style="background:#eceff1; font-weight:bold; color:#78909c">${r}</td>`;
            for(let c=1; c<=LCD_SIZE; c++){
                const td = document.createElement('td');
                td.className = 'data-cell';
                td.textContent = r*c;
                td.id = `cell-${r}-${c}`;
                row.appendChild(td);
            }
            table.appendChild(row);
        }
    }

    function lcd_setMode(mode) {
        lcd_mode = mode;
        const btnExp = document.getElementById('btn-lcd-explore');
        const btnCha = document.getElementById('btn-lcd-challenge');
        const dash = document.getElementById('lcd-dashboard');
        const box = document.getElementById('challengeBox');

        lcd_reset(); 

        if(mode === 'explore') {
            btnExp.className = 'btn btn-gold';
            btnCha.className = 'btn btn-outline';
            dash.style.display = 'flex';
            box.style.display = 'none';
        } else {
            btnExp.className = 'btn btn-outline';
            btnCha.className = 'btn btn-gold';
            dash.style.display = 'none';
            box.style.display = 'block';
            lcd_genChallenge();
        }
    }

    function lcd_select(num) {
        if(lcd_animating || lcd_mode === 'challenge') return;
        
        const narr = document.getElementById('narration');
        const btn = document.getElementById('lcd-btn-anim');

        if(lcd_selA !== null && lcd_selB !== null) {
            lcd_reset();
        }

        if(lcd_selA === null) {
            lcd_selA = num;
            lcd_highlightCol(num, 'sel-green');
            narr.innerHTML = `Selected <span style="color:var(--c-green); font-weight:bold">${num}</span>. Now pick a second.`;
        } else if(lcd_selB === null && num !== lcd_selA) {
            lcd_selB = num;
            lcd_highlightCol(num, 'sel-blue');
            narr.innerHTML = `Selected <span style="color:var(--c-green); font-weight:bold">${lcd_selA}</span> and <span style="color:var(--c-blue); font-weight:bold">${lcd_selB}</span>.`;
            btn.disabled = false;
        }
    }

    function lcd_highlightCol(col, cls) {
        const headers = document.querySelectorAll('.col-header');
        if(headers[col-1]) headers[col-1].classList.add(cls);
    }

    function lcd_animate() {
        if(!lcd_selA || !lcd_selB) return;
        document.getElementById('lcd-btn-anim').disabled = true;
        lcd_animating = true;
        
        const myLcm = lcm(lcd_selA, lcd_selB);
        let r = 1;

        const interval = setInterval(() => {
            if(r > LCD_SIZE) { 
                clearInterval(interval); 
                lcd_animating = false;
                return; 
            }
            
            const cellA = document.getElementById(`cell-${r}-${lcd_selA}`);
            if(cellA) {
                cellA.classList.add('hl-green');
                if(r * lcd_selA === myLcm) cellA.classList.add('lcd-match');
            }
            
            const cellB = document.getElementById(`cell-${r}-${lcd_selB}`);
            if(cellB) {
                cellB.classList.add('hl-blue');
                if(r * lcd_selB === myLcm) cellB.classList.add('lcd-match');
            }

            if(r * lcd_selA >= myLcm && r * lcd_selB >= myLcm) {
               document.getElementById('narration').innerHTML = 
               `Match found! The LCD is <span style="color:#f57f17; font-size:1.5rem; font-weight:bold">${myLcm}</span>`;
            }
            r++;
        }, 150);
    }

    function lcd_reset() {
        lcd_selA = null; lcd_selB = null; lcd_animating = false;
        
        if(lcd_mode === 'explore') {
            document.getElementById('narration').innerText = "Pick two denominators in the top row to start.";
            document.getElementById('lcd-btn-anim').disabled = true;
        }

        document.querySelectorAll('.col-header').forEach(el => el.classList.remove('sel-green', 'sel-blue'));
        document.querySelectorAll('.data-cell').forEach(el => el.classList.remove('hl-green', 'hl-blue', 'lcd-match'));
    }

    function lcd_genChallenge() {
        const pairs = [[2,3],[2,5],[3,4],[3,5],[4,5],[2,7],[3,7],[4,6],[6,8],[3,8]];
        lcd_pair = pairs[Math.floor(Math.random()*pairs.length)];
        
        document.getElementById('challengePrompt').innerHTML = 
            `Find the LCD of <span style="color:var(--c-green); font-weight:bold">${lcd_pair[0]}</span> and <span style="color:var(--c-blue); font-weight:bold">${lcd_pair[1]}</span>`;
        document.getElementById('challengeInput').value = '';
        document.getElementById('challengeFeedback').innerText = '';
        
        lcd_highlightCol(lcd_pair[0], 'sel-green');
        lcd_highlightCol(lcd_pair[1], 'sel-blue');
    }

    function lcd_checkAnswer() {
        if(!lcd_pair) return;
        const val = parseInt(document.getElementById('challengeInput').value);
        const ans = lcm(lcd_pair[0], lcd_pair[1]);
        const fb = document.getElementById('challengeFeedback');
        
        if(val === ans) {
            fb.innerHTML = '<span style="color:var(--c-green)">Correct! ✓</span>';
            const rowA = ans / lcd_pair[0];
            const rowB = ans / lcd_pair[1];
            document.getElementById(`cell-${rowA}-${lcd_pair[0]}`).classList.add('lcd-match');
            document.getElementById(`cell-${rowB}-${lcd_pair[1]}`).classList.add('lcd-match');
            setTimeout(() => {
                lcd_reset();
                lcd_genChallenge();
            }, 2000);
        } else {
            fb.innerHTML = '<span style="color:var(--c-red)">Try Again</span>';
        }
    }

    // FIX 4: Clean initialization — set state directly, no double-toggle hack
    (function init() {
        // Ensure state matches the DOM defaults
        state.unlikeMode = false;
        state.showCommon = false;
        state.n1 = parseInt(document.getElementById('n1').value) || 1;
        state.n2 = parseInt(document.getElementById('n2').value) || 1;
        state.d1 = parseInt(document.getElementById('d1').value) || 4;
        state.d2 = state.d1; // Sync d2 to d1 in like-denom mode
        document.getElementById('d2').value = state.d2;
        document.getElementById('d2').disabled = true;
        document.getElementById('mode-toggle').classList.remove('active');
        document.getElementById('btn-common').style.display = 'none';
        
        updateLab();
        lcd_init();
    })();

</script>
</body>
</html>
